name: CI Build
on:
  pull_request:
  push:
    branches:
      - master
      - 'release/**'
      - 'maintainers/**'
  workflow_dispatch:

# Checks if any concurrent jobs under the same pull request or branch are being executed
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  paths-filter:
    runs-on: ubuntu-latest
    outputs:
      driver_changed: ${{ steps.filter.outputs.driver }}
      libscap_changed: ${{ steps.filter.outputs.libscap }}
      libsinsp_changed: ${{ steps.filter.outputs.libsinsp }}
    steps:
    - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
    - uses: dorny/paths-filter@4512585405083f25c027a35db413c2b3b9006d50 # v2.11.1
      id: filter
      with:
        filters: |
          driver:
            - 'driver/**'
          libscap:
            - 'userspace/libscap/**'
          libsinsp:
            - 'userspace/libsinsp/**'

  build-libs-linux-amd64:
    name: build-libs-linux-amd64 ðŸ˜
    strategy:
      matrix:
        name: [system_deps, bundled_deps, system_deps_w_chisels, system_deps_minimal]
        include:
          - name: system_deps
            cmake_opts: -DBUILD_WARNINGS_AS_ERRORS=On -DBUILD_BPF=On -DUSE_BUNDLED_DEPS=False
          - name: bundled_deps
            cmake_opts: -DBUILD_WARNINGS_AS_ERRORS=On -DBUILD_BPF=On -DUSE_BUNDLED_DEPS=True
          - name: system_deps_w_chisels
            cmake_opts: -DBUILD_WARNINGS_AS_ERRORS=On -DBUILD_BPF=On -DUSE_BUNDLED_DEPS=False -DWITH_CHISEL=True
          - name: system_deps_minimal
            cmake_opts: -DBUILD_WARNINGS_AS_ERRORS=On -DUSE_BUNDLED_DEPS=False -DMINIMAL_BUILD=True
    runs-on: ubuntu-latest
    container:
      image: debian:buster
    steps:
      - name: Install deps â›“ï¸
        run: |
          apt update && apt install -y --no-install-recommends ca-certificates cmake build-essential git clang llvm pkg-config autoconf automake libtool libelf-dev wget libc-ares-dev libcurl4-openssl-dev libssl-dev libtbb-dev libjq-dev libjsoncpp-dev libgrpc++-dev protobuf-compiler-grpc libgtest-dev libprotobuf-dev liblua5.1-dev linux-headers-amd64

      - name: Checkout Libs â¤µï¸
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0

      - name: Install deps â›“ï¸
        run: |
          .github/install-deps.sh

      - name: Git safe directory
        run: |
          git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Build and test ðŸ—ï¸ðŸ§ª
        run: |
          mkdir -p build
          cd build && cmake ${{ matrix.cmake_opts }} ../
          KERNELDIR=/lib/modules/$(ls /lib/modules)/build make -j4
          make run-unit-tests

  build-libs-linux-amd64-asan:
    name: build-libs-linux-amd64-asan ðŸ§
    runs-on: ubuntu-latest
    container:
      image: debian:buster
    steps:
      - name: Install deps â›“ï¸
        run: |
          apt update && apt install -y --no-install-recommends ca-certificates cmake build-essential git clang llvm pkg-config autoconf automake libtool libelf-dev wget libc-ares-dev libcurl4-openssl-dev libssl-dev libtbb-dev libjq-dev libjsoncpp-dev libgrpc++-dev protobuf-compiler-grpc libgtest-dev libprotobuf-dev liblua5.1-dev linux-headers-amd64

      - name: Checkout Libs â¤µï¸
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0

      - name: Install deps â›“ï¸
        run: |
          .github/install-deps.sh

      - name: Git safe directory
        run: |
          git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Build and test ðŸ—ï¸ðŸ§ª
        run: |
          mkdir -p build
          cd build && LDFLAGS="-lpthread" cmake -DCMAKE_C_FLAGS=-fsanitize=address -DCMAKE_CXX_FLAGS=-fsanitize=address -DUSE_BUNDLED_DEPS=False ../
          KERNELDIR=/lib/modules/$(ls /lib/modules)/build make -j4
          make run-unit-tests


  # This job run all engine tests and scap-open
  test-scap-x86:
    name: test-scap-x86 ðŸ˜† (bundled_deps)
    runs-on: ubuntu-22.04
    needs: paths-filter
    if: needs.paths-filter.outputs.driver_changed == 'true' || needs.paths-filter.outputs.libscap_changed == 'true'
    steps:

      - name: Checkout Libs â¤µï¸
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0

      - name: Install deps â›“ï¸
        run: |
          sudo apt update
          sudo apt install -y --no-install-recommends ca-certificates cmake build-essential clang-14 llvm-14 git pkg-config autoconf automake libtool libelf-dev libcap-dev linux-headers-$(uname -r)
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-14 90
          sudo update-alternatives --install /usr/bin/llvm-strip llvm-strip /usr/bin/llvm-strip-14 90
          sudo update-alternatives --install /usr/bin/llc llc /usr/bin/llc-14 90

      - name: Build scap-open and drivers ðŸ—ï¸
        run: |
          mkdir -p build
          cd build && cmake -DUSE_BUNDLED_DEPS=On -DBUILD_DRIVER=ON -DBUILD_LIBSCAP_MODERN_BPF=ON -DBUILD_BPF=On -DBUILD_LIBSCAP_GVISOR=On -DCREATE_TEST_TARGETS=On -DENABLE_LIBSCAP_TESTS=On ../
          make scap-open
          make driver bpf
          make libscap_test

      - name: Run scap-open with modern bpf ðŸŽï¸
        run: |
          cd build
          sudo ./libscap/examples/01-open/scap-open --modern_bpf --num_events 0

      - name: Run scap-open with bpf ðŸŽï¸
        run: |
          cd build
          sudo ./libscap/examples/01-open/scap-open --bpf ./driver/bpf/probe.o --num_events 0

      - name: Run scap-open with kmod ðŸŽï¸
        run: |
          cd build
          sudo insmod ./driver/scap.ko
          sudo ./libscap/examples/01-open/scap-open --kmod --num_events 0
          sudo rmmod scap

      - name: Run libscap_test ðŸŽï¸
        run: |
          cd build
          sudo ./test/libscap/libscap_test

  test-drivers-s390x:
    name: test-drivers-s390x ðŸ˜‡ (system_deps)
    runs-on: [self-hosted]
    needs: paths-filter
    if: needs.paths-filter.outputs.driver_changed == 'true' || needs.paths-filter.outputs.libscap_changed == 'true'
    steps:

      - name: Checkout Libs â¤µï¸
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0

      - name: Build drivers tests ðŸ—ï¸
        run: |
          mkdir -p build
          cd build && cmake -DUSE_BUNDLED_DEPS=ON -DENABLE_DRIVERS_TESTS=ON -DBUILD_LIBSCAP_MODERN_BPF=ON -DMODERN_BPF_DEBUG_MODE=ON -DBUILD_BPF=True -DBUILD_LIBSCAP_GVISOR=OFF ../
          make drivers_test
          make driver bpf

      - name: Run drivers_test with modern bpf ðŸŽï¸
        run: |
          cd build
          sudo ./test/drivers/drivers_test -m

      - name: Run drivers_test with bpf ðŸŽï¸
        run: |
          cd build
          sudo ./test/drivers/drivers_test -b

      - name: Run drivers_test with kmod ðŸŽï¸
        run: |
          cd build
          sudo ./test/drivers/drivers_test -k

  build-drivers-s390x-ppc64le:
    name: build-drivers-${{ matrix.arch }} ðŸ˜ (system_deps)
    runs-on: ubuntu-22.04
    needs: paths-filter
    if: needs.paths-filter.outputs.driver_changed == 'true' || needs.paths-filter.outputs.libscap_changed == 'true'
    strategy:
      matrix:
        arch: [s390x, ppc64le]
      fail-fast: false
    env:
      PLATFORM: ${{ matrix.arch == 'ppc64le' && 'powerpc64le' || 's390x' }}
    steps:

      - name: Checkout Libs â¤µï¸
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0

      - uses: uraimo/run-on-arch-action@4ed76f16f09d12e83abd8a49e1ac1e5bf08784d4 # v2.5.1
        name: Run ${{ matrix.arch }} build ðŸ—ï¸
        with:
          arch: ${{ matrix.arch }}
          distro: ubuntu22.04
          githubToken: ${{ github.token }}

          install: |
            apt update && apt install -y --no-install-recommends ca-certificates cmake build-essential clang llvm git pkg-config autoconf automake libtool libelf-dev wget libc-ares-dev libcurl4-openssl-dev libssl-dev libtbb-dev libjq-dev libjsoncpp-dev libgrpc++-dev protobuf-compiler-grpc libcap-dev libgtest-dev libprotobuf-dev linux-headers-generic            
            git clone https://github.com/libbpf/bpftool.git --branch v7.0.0 --single-branch
            cd bpftool
            git submodule update --init
            cd src && make install
            cd ../../
            git clone https://github.com/libbpf/libbpf.git --branch v1.0.1 --single-branch
            cd libbpf/src && BUILD_STATIC_ONLY=y DESTDIR=/ make install
            ln -s /usr/lib64/libbpf.a /usr/lib/${{env.PLATFORM}}-linux-gnu/
          # Please note: we cannot inject the BPF probe inside QEMU, so right now, we only build it
          run: |
            git config --global --add safe.directory $GITHUB_WORKSPACE
            .github/install-deps.sh
            mkdir -p build
            cd build && cmake -DBUILD_BPF=On -DUSE_BUNDLED_DEPS=OFF -DMODERN_PROBE_INCLUDE="-I/usr/include/${{env.PLATFORM}}-linux-gnu" -DBUILD_LIBSCAP_MODERN_BPF=ON -DMODERN_BPF_DEBUG_MODE=ON -DENABLE_DRIVERS_TESTS=On -DCREATE_TEST_TARGETS=On -DBUILD_LIBSCAP_GVISOR=OFF ../
            KERNELDIR=/lib/modules/$(ls /lib/modules)/build make driver bpf drivers_test -j6

  # This job checks that a bundled deps of libs is as static as possible
  test-libs-static:
    name: test-libs-static (bundled_deps)
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Libs â¤µï¸
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0

      - name: Install deps â›“ï¸
        run: |
          sudo apt update
          sudo apt install -y --no-install-recommends ca-certificates cmake build-essential clang-14 llvm-14 git pkg-config autoconf automake libtool libelf-dev libcap-dev linux-headers-$(uname -r)
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-14 90
          sudo update-alternatives --install /usr/bin/llvm-strip llvm-strip /usr/bin/llvm-strip-14 90
          sudo update-alternatives --install /usr/bin/llc llc /usr/bin/llc-14 90

      - name: Build sinsp-example
        run: |
          mkdir -p build
          cd build && cmake -DUSE_BUNDLED_DEPS=On -DBUILD_DRIVER=ON -DBUILD_LIBSCAP_MODERN_BPF=ON -DBUILD_BPF=On -DBUILD_LIBSCAP_GVISOR=On -DCREATE_TEST_TARGETS=Off -DENABLE_LIBSCAP_TESTS=Off ../
          make -j$(nproc) sinsp-example

      - name: Ensure that sinsp-example with bundled deps is as static as possible
        run: |
          ldd "build/libsinsp/examples/sinsp-example" | cut --fields=2 | cut --delimiter=' ' --fields=1 | rev | cut --delimiter='/' --fields=1 | rev | sort --unique --version-sort > ldd_out.txt
          cat > expected_ldd_out.txt <<EOF
          ld-linux-x86-64.so.2
          libc.so.6
          libgcc_s.so.1
          libm.so.6
          libstdc++.so.6
          linux-vdso.so.1
          EOF
          diff -u expected_ldd_out.txt ldd_out.txt

